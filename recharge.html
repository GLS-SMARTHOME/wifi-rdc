<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>User Login & Random Item</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f7f7f7;
    padding: 20px;
    display: flex;
    justify-content: center;
  }
  .container {
    background: white;
    padding: 20px;
    max-width: 400px;
    width: 100%;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  h2 {
    text-align: center;
  }
  select, button {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  button {
    background: #007BFF;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }
  button:disabled {
    background: #cccccc;
    cursor: default;
  }
  button:hover:enabled {
    background: #0056b3;
  }
  .result {
    margin-top: 15px;
    padding: 10px;
    background: #e9ffe9;
    border: 1px solid #b2ffb2;
    border-radius: 4px;
    text-align: center;
  }
  .error {
    color: red;
    text-align: center;
  }
  #userHistory {
    margin-top: 15px;
    background: #f0f8ff;
    border-radius: 6px;
    padding: 10px;
  }
  #userHistory h3 {
    margin-top: 0;
  }
</style>
</head>
<body>

<div class="container">
  <h2>GLS WIFI Login</h2>
  <select id="username">
    <option value="">Choisir Agent</option>
    <option value="Galois">Galois</option>
    <option value="Salem">Salem</option>
    <option value="Tryphose">Tryphose</option>
  </select>
  <button id="loginBtn">Login</button>
  <button id="getCodeBtn" disabled>Get Code</button>
  <div id="error" class="error"></div>
  <div id="result" class="result" style="display:none;"></div>

  <div id="userHistory" style="display:none;"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  // ==== CONFIGURE FIREBASE ====
  const firebaseConfig = {
    apiKey: "AIzaSyBSE0qs8lxr0x-xQL0jt47gNfjiOY5Z9BE",
    authDomain: "wifi-rdc.firebaseapp.com",
    databaseURL: "https://wifi-rdc-default-rtdb.firebaseio.com",
    projectId: "wifi-rdc",
    storageBucket: "wifi-rdc.firebasestorage.app",
    messagingSenderId: "1091268810655",
    appId: "1:1091268810655:web:2ba01f8adf7f190cd00faa",
    measurementId: "G-B53B9JCJXY"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let loggedInUser = null;
  let lastClickTime = 0;

  // LOGIN
  document.getElementById('loginBtn').addEventListener('click', async () => {
    const username = document.getElementById('username').value;
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = "";
    document.getElementById('result').style.display = "none";
    document.getElementById('getCodeBtn').disabled = true;
    document.getElementById('userHistory').style.display = "none";

    if (!username) {
      errorDiv.textContent = "Choisir un agent SVP! .";
      return;
    }

    try {
      // Get password for user from Firebase
      const snapshot = await db.ref("users_passwords/" + username).once("value");
      if (!snapshot.exists()) {
        errorDiv.textContent = "Agent non operationnel!.";
        return;
      }
      const storedData = snapshot.val();

      let storedPassword;
      if (typeof storedData === "string") {
        storedPassword = storedData;
      } else if (storedData && typeof storedData.password === "string") {
        storedPassword = storedData.password;
      } else {
        errorDiv.textContent = "Mot de password incorrect!";
        return;
      }

      const enteredPassword = prompt(`Enter password for ${username}:`);
      if (enteredPassword === null) {
        errorDiv.textContent = "Login annulé.";
        return;
      }

      if (enteredPassword.trim() !== storedPassword.trim()) {
        errorDiv.textContent = "password incorrect";
        return;
      }

      loggedInUser = username;
      errorDiv.textContent = "Login reussi !.";
      document.getElementById('getCodeBtn').disabled = false;
      showUserHistory(loggedInUser);

    } catch (err) {
      errorDiv.textContent = "Error: " + err.message;
    }
  });

  // GET CODE button click
  document.getElementById('getCodeBtn').addEventListener('click', async () => {
    const now = Date.now();
    const errorDiv = document.getElementById('error');
    const resultDiv = document.getElementById('result');
    errorDiv.textContent = "";
    resultDiv.style.display = "none";

    if (!loggedInUser) {
      errorDiv.textContent = "Vous devez vous connectés!";
      return;
    }

    if (now - lastClickTime < 5000) {
      errorDiv.textContent = "attendre 5 secondes, puis réessayez!";
      return;
    }
    lastClickTime = now;

    try {
      const snapshot = await db.ref("myList").once("value");
      if (snapshot.exists()) {
        let list = snapshot.val();
        let itemsArray = Array.isArray(list)
          ? list.map((value, index) => ({ key: index, value }))
              .filter(item => item.value !== null && item.value !== undefined)
          : Object.keys(list).map(key => ({ key, value: list[key] }));

        if (itemsArray.length > 0) {
          const randomIndex = Math.floor(Math.random() * itemsArray.length);
          const chosenItem = itemsArray[randomIndex];
          resultDiv.textContent = "Code Wifi: " + chosenItem.value;
          resultDiv.style.display = "block";

          await db.ref("myList").child(chosenItem.key).remove();

          const timestamp = new Date().toISOString();
          await db.ref("pickedItems").child(loggedInUser).push({
            item: chosenItem.value,
            time: timestamp
          });

          showUserHistory(loggedInUser);

        } else {
          errorDiv.textContent = "Liste Database est vide.";
        }
      } else {
        errorDiv.textContent = "Aucune donnée trouvé in database.";
      }
    } catch (err) {
      errorDiv.textContent = "Error: " + err.message;
    }
  });

  // Show user-specific pick history
  function showUserHistory(username) {
    const userHistoryDiv = document.getElementById('userHistory');
    db.ref("pickedItems").child(username).once("value", snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        let html = "<h3>Historique de vente</h3><ul>";
        for (let recordKey in data) {
          const record = data[recordKey];
          html += `<li>${record.item} <em>(${new Date(record.time).toLocaleString()})</em></li>`;
        }
        html += "</ul>";
        userHistoryDiv.innerHTML = html;
      } else {
        userHistoryDiv.innerHTML = "<p>Faites votre 1er Vente !  </p>";
      }
      userHistoryDiv.style.display = "block";
    });
  }
</script>

</body>
</html>
